import React, { useState, useEffect } from 'react';

// Modelos predefinidos del PDF
const MODELOS_CON_CONSUMO = {
  '46-GI-30MDI': 6.5,
  '46-GI-33MDFW': 7.75,
  '46-GI-70DE': 15.6,
  '46-GI-70BM': 15.8,
  '46-GI-30FW': 7.0,
  '46-GI-25MDFW-X': 7.0,
  '46-GI-15MDQ': 4.4,
  '46-GI-25MDFW': 7.0,
  '46-GI-50FW': 11.0,
  '46-GI-75C-X': 13.1,
  '46-GI-75C': 13.1,
  'CU28LDE': 13.1,
  'JHON DEERE 65KVA': 15.0,
  'JYX24SA2': 5.0,
  'GI-30I-S': 7.75,
  'GI-55I-M': 11.0,
  '46-GI-40ZI': 9.0,
  '46-GI-240-Z': 50.0
};

export default function AdminPlantas() {
  const [plantas, setPlantas] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [mensaje, setMensaje] = useState({ texto: '', tipo: '' });
  const [consumos, setConsumos] = useState({});
  
  const [nuevaPlanta, setNuevaPlanta] = useState({
    nombre_monitor: '',
    sede: '',
    modelo: '',
    consumo_lh: ''
  });

  // Cargar plantas al inicio
  useEffect(() => {
    cargarPlantas();
    // Actualizar cada 10 segundos
    const interval = setInterval(cargarConsumosActivos, 10000);
    return () => clearInterval(interval);
  }, []);

  const cargarPlantas = async () => {
    try {
      const res = await fetch('http://10.10.31.31:8080/api/combustible/plantas');
      const data = await res.json();
      if (data.success) {
        setPlantas(data.data);
        // Cargar consumos de plantas activas
        cargarConsumosActivos(data.data);
      }
    } catch (error) {
      console.error('Error cargando plantas:', error);
      mostrarMensaje('Error al cargar plantas', 'error');
    } finally {
      setLoading(false);
    }
  };

  const cargarConsumosActivos = async (plantasList = plantas) => {
    const nuevosConsumos = {};
    for (const planta of plantasList) {
      try {
        const res = await fetch(`http://10.10.31.31:8080/api/combustible/consumo/${encodeURIComponent(planta.nombre_monitor)}`);
        const data = await res.json();
        if (data.success && data.data.esta_encendida_ahora) {
          nuevosConsumos[planta.nombre_monitor] = data.data.consumo_actual_sesion;
        }
      } catch (error) {
        // Ignorar errores individuales
      }
    }
    setConsumos(nuevosConsumos);
  };

  const mostrarMensaje = (texto, tipo) => {
    setMensaje({ texto, tipo });
    setTimeout(() => setMensaje({ texto: '', tipo: '' }), 3000);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    try {
      const res = await fetch('http://10.10.31.31:8080/api/combustible/plantas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(nuevaPlanta)
      });
      
      const data = await res.json();
      if (data.success) {
        mostrarMensaje('âœ… Planta agregada correctamente', 'success');
        setShowForm(false);
        setNuevaPlanta({ nombre_monitor: '', sede: '', modelo: '', consumo_lh: '' });
        cargarPlantas();
      } else {
        mostrarMensaje('âŒ ' + data.error, 'error');
      }
    } catch (error) {
      mostrarMensaje('âŒ Error al conectar con el servidor', 'error');
    }
  };

  const handleModeloChange = (modelo) => {
    setNuevaPlanta({
      ...nuevaPlanta,
      modelo,
      consumo_lh: MODELOS_CON_CONSUMO[modelo] || ''
    });
  };

  const getStatusColor = (planta) => {
    if (consumos[planta.nombre_monitor]) {
      return { bg: '#16a34a', text: 'white', label: 'ðŸŸ¢ ENCENDIDA' };
    }
    return { bg: '#6b7280', text: 'white', label: 'âš« APAGADA' };
  };

  if (loading) {
    return (
      <div style={{ padding: 40, textAlign: 'center' }}>
        <div className="spinner" style={{
          border: '4px solid #f3f3f3',
          borderTop: '4px solid #3b82f6',
          borderRadius: '50%',
          width: 40,
          height: 40,
          margin: '0 auto 20px',
          animation: 'spin 1s linear infinite'
        }} />
        <p>Cargando plantas...</p>
        <style>{`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        `}</style>
      </div>
    );
  }

  return (
    <div style={{ padding: '24px' }}>
      <style>{`
        .admin-plantas table {
          width: 100%;
          border-collapse: collapse;
          background: white;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .dark-mode .admin-plantas table {
          background: #1a1e24;
        }
        .admin-plantas th {
          text-align: left;
          padding: 16px;
          background: #f3f4f6;
          border-bottom: 2px solid #e5e7eb;
          font-weight: 600;
        }
        .dark-mode .admin-plantas th {
          background: #2d3238;
          color: #e5e7eb;
          border-bottom-color: #374151;
        }
        .admin-plantas td {
          padding: 16px;
          border-bottom: 1px solid #e5e7eb;
        }
        .dark-mode .admin-plantas td {
          border-bottom-color: #374151;
          color: #e5e7eb;
        }
        .admin-plantas tr:hover {
          background: #f9fafb;
        }
        .dark-mode .admin-plantas tr:hover {
          background: #2d3238;
        }
        .badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 999px;
          font-size: 0.8rem;
          font-weight: 600;
        }
        .mensaje {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 24px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          animation: slideIn 0.3s ease;
        }
        .mensaje.success {
          background: #d1fae5;
          color: #065f46;
          border: 1px solid #a7f3d0;
        }
        .mensaje.error {
          background: #fee2e2;
          color: #991b1b;
          border: 1px solid #fecaca;
        }
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        .form-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
        }
        @media (max-width: 768px) {
          .form-grid {
            grid-template-columns: 1fr;
          }
        }
        .floating-btn {
          position: fixed;
          bottom: 30px;
          right: 30px;
          width: 60px;
          height: 60px;
          border-radius: 30px;
          background: #3b82f6;
          color: white;
          border: none;
          font-size: 24px;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(59,130,246,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 999;
          transition: all 0.2s ease;
        }
        .floating-btn:hover {
          transform: scale(1.1);
          background: #2563eb;
        }
        .floating-btn.close {
          background: #ef4444;
          transform: rotate(45deg);
        }
        .floating-btn.close:hover {
          background: #dc2626;
        }
      `}</style>

      {/* Mensaje flotante */}
      {mensaje.texto && (
        <div className={`mensaje ${mensaje.tipo}`}>
          {mensaje.texto}
        </div>
      )}

      {/* Header */}
      <div style={{ 
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center', 
        marginBottom: 24 
      }}>
        <h1 style={{ margin: 0 }}>âš¡ AdministraciÃ³n de Plantas ElÃ©ctricas</h1>
        <div style={{ fontSize: '0.9rem', color: '#6b7280' }}>
          Total: {plantas.length} plantas
        </div>
      </div>

      {/* Formulario */}
      {showForm && (
        <div style={{
          background: 'white',
          borderRadius: 12,
          padding: 24,
          marginBottom: 24,
          boxShadow: '0 4px 6px rgba(0,0,0,0.05)'
        }}>
          <h3 style={{ marginTop: 0, marginBottom: 20 }}>Agregar Nueva Planta</h3>
          
          <form onSubmit={handleSubmit}>
            <div className="form-grid">
              <div>
                <label style={{ display: 'block', marginBottom: 4, fontWeight: 500 }}>
                  Nombre del Monitor:
                </label>
                <input
                  type="text"
                  value={nuevaPlanta.nombre_monitor}
                  onChange={(e) => setNuevaPlanta({...nuevaPlanta, nombre_monitor: e.target.value})}
                  placeholder="PLANTA ELECTRICA EJEMPLO"
                  style={{ width: '100%', padding: 10, borderRadius: 6, border: '1px solid #e5e7eb' }}
                  required
                />
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: 4, fontWeight: 500 }}>
                  Sede:
                </label>
                <input
                  type="text"
                  value={nuevaPlanta.sede}
                  onChange={(e) => setNuevaPlanta({...nuevaPlanta, sede: e.target.value})}
                  placeholder="Calabozo, El Rosal, etc."
                  style={{ width: '100%', padding: 10, borderRadius: 6, border: '1px solid #e5e7eb' }}
                  required
                />
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: 4, fontWeight: 500 }}>
                  Modelo:
                </label>
                <select
                  value={nuevaPlanta.modelo}
                  onChange={(e) => handleModeloChange(e.target.value)}
                  style={{ width: '100%', padding: 10, borderRadius: 6, border: '1px solid #e5e7eb' }}
                  required
                >
                  <option value="">Seleccionar modelo</option>
                  {Object.keys(MODELOS_CON_CONSUMO).map(m => (
                    <option key={m} value={m}>
                      {m} ({MODELOS_CON_CONSUMO[m]} L/h)
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: 4, fontWeight: 500 }}>
                  Consumo (L/h):
                </label>
                <input
                  type="number"
                  step="0.1"
                  value={nuevaPlanta.consumo_lh}
                  onChange={(e) => setNuevaPlanta({...nuevaPlanta, consumo_lh: e.target.value})}
                  style={{ width: '100%', padding: 10, borderRadius: 6, border: '1px solid #e5e7eb' }}
                  required
                />
              </div>
            </div>

            <div style={{ marginTop: 20, display: 'flex', gap: 10 }}>
              <button type="submit" style={{
                padding: '10px 24px',
                background: '#3b82f6',
                color: 'white',
                border: 'none',
                borderRadius: 6,
                cursor: 'pointer',
                fontWeight: 500
              }}>
                Guardar Planta
              </button>
              <button type="button" onClick={() => setShowForm(false)} style={{
                padding: '10px 24px',
                background: '#e5e7eb',
                border: 'none',
                borderRadius: 6,
                cursor: 'pointer',
                fontWeight: 500
              }}>
                Cancelar
              </button>
            </div>
          </form>
        </div>
      )}

      {/* Tabla de plantas */}
      <div className="admin-plantas">
        <table>
          <thead>
            <tr>
              <th>Monitor</th>
              <th>Sede</th>
              <th>Modelo</th>
              <th>Consumo L/h</th>
              <th>Estado</th>
              <th>Consumo Actual</th>
            </tr>
          </thead>
          <tbody>
            {plantas.map(planta => {
              const status = getStatusColor(planta);
              const consumoActual = consumos[planta.nombre_monitor] || 0;
              
              return (
                <tr key={planta.id}>
                  <td><strong>{planta.nombre_monitor}</strong></td>
                  <td>{planta.sede}</td>
                  <td>{planta.modelo}</td>
                  <td>{planta.consumo_lh} L/h</td>
                  <td>
                    <span className="badge" style={{
                      background: status.bg,
                      color: status.text
                    }}>
                      {status.label}
                    </span>
                  </td>
                  <td>
                    {consumoActual > 0 ? (
                      <span style={{ color: '#16a34a', fontWeight: 600 }}>
                        {consumoActual.toFixed(2)} L
                      </span>
                    ) : (
                      <span style={{ color: '#6b7280' }}>â€”</span>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* BotÃ³n flotante */}
      <button
        className={`floating-btn ${showForm ? 'close' : ''}`}
        onClick={() => setShowForm(!showForm)}
      >
        {showForm ? '+' : '+'}
      </button>
    </div>
  );
}
