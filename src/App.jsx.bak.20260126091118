import { useEffect, useMemo, useState } from "react";
import Cards from "./components/Cards.jsx";
import Filters from "./components/Filters.jsx";
import ServiceGrid from "./components/ServiceGrid.jsx";
import MonitorsTable from "./components/MonitorsTable.jsx";
import InstanceDetail from "./components/InstanceDetail.jsx";
import { fetchSummary, fetchMonitors, openStream, getBlocklist, saveBlocklist } from "./api.js";

function getRoute(){
  const parts = (window.location.hash||"").slice(1).split("/").filter(Boolean);
  if (parts[0]==="sede" && parts[1]) return { name:"sede", instance: decodeURIComponent(parts[1]) };
  return { name:"home" };
}

export default function App(){
  const [summary,setSummary]=useState({up:0,down:0,total:0,avgResponseTimeMs:null});
  const [monitors,setMonitors]=useState([]);
  const [filters,setFilters]=useState({instance:"",type:"",q:"",onlyDown:false});
  const [hidden,setHidden]=useState(new Set());
  const [view,setView]=useState("grid");
  const [route,setRoute]=useState(getRoute());

  useEffect(()=>{
    const onHash=()=>setRoute(getRoute());
    window.addEventListener("hashchange",onHash);
    return ()=>window.removeEventListener("hashchange",onHash);
  },[]);

  useEffect(()=>{
    (async ()=>{
      try{
        const s=await fetchSummary(); setSummary(s||{});
        const ms=await fetchMonitors(); setMonitors(ms||[]);
        const bl=await getBlocklist(); setHidden(new Set((bl?.monitors||[]).map(k=>`${k.instance}|${k.name}`)));
      }catch{ /* ignora para producciÃ³n simple */ }
    })();
    const close = openStream(p=>{
      const ms=p?.monitors||[];
      setMonitors(ms);
      const up=ms.filter(m=>m.latest?.status===1).length;
      const down=ms.filter(m=>m.latest?.status===0).length;
      const rt=ms.map(m=>m.latest?.responseTime).filter(v=>v!=null);
      setSummary({up,down,total:ms.length,avgResponseTimeMs: rt.length? Math.round(rt.reduce((a,b)=>a+b,0)/rt.length):null});
    });
    return close;
  },[]);

  const filteredAll = useMemo(()=> (monitors||[]).filter(m=>{
    if (filters.instance && m.instance!==filters.instance) return false;
    if (filters.type && m.info?.monitor_type!==filters.type) return false;
    if (filters.onlyDown && m.latest?.status!==0) return false;
    if (filters.q){
      const hay = `${m.info?.monitor_name||""} ${m.info?.monitor_url||""} ${m.info?.monitor_hostname||""}`.toLowerCase();
      if (!hay.includes(filters.q.toLowerCase())) return false;
    }
    return true;
  }), [monitors,filters]);

  const visible = filteredAll.filter(m=>!hidden.has(`${m.instance}|${m.info?.monitor_name}`));

  async function persistHidden(next){
    const arr=[...next].map(k=>{const [instance,name]=k.split("|");return {instance,name};});
    await saveBlocklist({monitors:arr}); setHidden(next);
  }
  function onHide(instance,name){ const next=new Set(hidden); next.add(`${instance}|${name}`); persistHidden(next); }
  function onUnhide(instance,name){ const next=new Set(hidden); next.delete(`${instance}|${name}`); persistHidden(next); }
  function onHideAll(instance){
    const next = new Set(hidden);
    filteredAll.filter(m=>m.instance===instance).forEach(m=>next.add(`${m.instance}|${m.info?.monitor_name}`));
    persistHidden(next);
  }
  async function onUnhideAll(instance){
    const bl=await getBlocklist();
    const nextArr=(bl?.monitors||[]).filter(k=>k.instance!==instance);
    await saveBlocklist({monitors:nextArr});
    setHidden(new Set(nextArr.map(k=>`${k.instance}|${k.name}`)));
  }

  function openInstance(name){ window.location.hash="/sede/"+encodeURIComponent(name); }
  function tabBtn(v,t){ return <button className={`btn tab ${view===v?"active":""}`} onClick={()=>setView(v)}>{t}</button>; }

  if (route.name==="sede"){
    return (
      <div className="container">
        <InstanceDetail
          instanceName={route.instance}
          monitorsAll={filteredAll}
          hiddenSet={hidden}
          onHide={onHide} onUnhide={onUnhide}
          onHideAll={onHideAll} onUnhideAll={onUnhideAll}
        />
      </div>
    );
  }

  return (
    <div className="container">
      <h1>Uptime Central</h1>
      <Cards summary={summary}/>
      <div className="controls">
        <Filters monitors={monitors} value={filters} onChange={setFilters}/>
        <div style={{display:"flex",gap:8}}>
          {tabBtn("grid","Grid")}
          {tabBtn("table","Tabla")}
        </div>
      </div>
      {view==="grid"
        ? <ServiceGrid monitorsAll={filteredAll} hiddenSet={hidden} onHideAll={onHideAll} onUnhideAll={onUnhideAll} onOpen={openInstance}/>
        : <MonitorsTable monitors={visible} hiddenSet={hidden} onHide={onHide} onUnhide={onUnhide}/>}
    </div>
  );
}
